<!doctype html>

<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual App â€” By Ricardo (11/25 Programs)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

:root{
â€“bg:#0a0e1a;
â€“bg-gradient: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
â€“card:#ffffff08;
â€“card-hover:#ffffff12;
â€“text:#e6ebff;
â€“muted:#8b92b0;
â€“border:#ffffff15;
â€“accent:#3b82f6;
â€“accent-hover:#2563eb;
â€“accent-glow: rgba(59, 130, 246, 0.3);
â€“chip:#1e293b;
â€“chip-text:#cbd5e1;
â€“danger:#ef4444;
â€“success:#10b981;
â€“radius:16px;
â€“shadow:0 20px 50px rgba(0,0,0,.4);
â€“glow: 0 0 20px var(â€“accent-glow);
â€“badge:#1e293b;
â€“badge-border:#334155;
}

[data-theme=â€œlightâ€]{
â€“bg:#f8fafc;
â€“bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
â€“card:#ffffff;
â€“card-hover:#f8fafc;
â€“text:#0f172a;
â€“muted:#64748b;
â€“border:#e2e8f0;
â€“accent:#3b82f6;
â€“accent-hover:#2563eb;
â€“accent-glow: rgba(59, 130, 246, 0.15);
â€“chip:#f1f5f9;
â€“chip-text:#475569;
â€“shadow:0 20px 50px rgba(15,23,42,.08);
â€“glow: 0 0 30px rgba(59, 130, 246, 0.1);
â€“badge:#f1f5f9;
â€“badge-border:#cbd5e1;
}

- { box-sizing: border-box; }

html,body{
margin:0;
padding:0;
background:var(â€“bg);
background-image: var(â€“bg-gradient);
background-attachment: fixed;
color:var(â€“text);
font:16px/1.6 â€˜Interâ€™, -apple-system, BlinkMacSystemFont, sans-serif;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.wrap{
max-width:1200px;
margin:0 auto;
padding:20px 16px 40px;
}

/* Animated gradient background */
body::before {
content: â€˜â€™;
position: fixed;
top: 0;
left: 0;
right: 0;
height: 400px;
background: radial-gradient(circle at 50% 0%, var(â€“accent-glow), transparent 60%);
opacity: 0.4;
pointer-events: none;
z-index: 0;
}

.top{
position:sticky;
top:0;
z-index:30;
backdrop-filter: blur(20px) saturate(180%);
background: var(â€“card);
border: 1px solid var(â€“border);
border-radius: var(â€“radius);
padding:16px 20px;
margin-bottom: 24px;
box-shadow: var(â€“shadow);
animation: slideDown 0.5s ease;
}

@keyframes slideDown {
from { transform: translateY(-20px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}

.brand{
display:flex;
gap:16px;
align-items:center;
justify-content:space-between;
flex-wrap:wrap;
}

.pill{
display:inline-flex;
align-items:center;
gap:10px;
background: linear-gradient(135deg, var(â€“accent), var(â€“accent-hover));
color:#fff;
padding:12px 20px;
border-radius:999px;
font-weight:700;
font-size:0.95rem;
letter-spacing:0.3px;
box-shadow: 0 4px 20px var(â€“accent-glow);
transition: all 0.3s ease;
}

.pill:hover {
transform: translateY(-2px);
box-shadow: 0 8px 30px var(â€“accent-glow);
}

.theme{
border:1px solid var(â€“border);
background:var(â€“card);
backdrop-filter: blur(10px);
color:var(â€“text);
padding:10px 18px;
border-radius:999px;
cursor:pointer;
font-weight:600;
transition: all 0.3s ease;
font-family: â€˜Interâ€™, sans-serif;
}

.theme:hover{
background:var(â€“card-hover);
border-color:var(â€“accent);
transform: translateY(-2px);
box-shadow: 0 4px 20px var(â€“accent-glow);
}

.card{
background:var(â€“card);
backdrop-filter: blur(20px) saturate(180%);
border:1px solid var(â€“border);
border-radius:var(â€“radius);
box-shadow:var(â€“shadow);
padding:24px;
transition: all 0.3s ease;
animation: fadeIn 0.5s ease;
}

.card:hover {
border-color: var(â€“accent-glow);
box-shadow: var(â€“shadow), var(â€“glow);
}

.controls{
position:sticky;
top:90px;
z-index:20;
}

.grid{
display:grid;
gap:16px;
}

.g3{
grid-template-columns:repeat(3, minmax(0,1fr));
}

.g2{
grid-template-columns:repeat(2, minmax(0,1fr));
}

@media (max-width:900px){
.g3,.g2{
grid-template-columns:1fr;
}
}

label{
font-size:0.875rem;
color:var(â€“muted);
display:block;
margin:0 0 8px;
font-weight:600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

select,input[type=â€œnumberâ€],input[type=â€œtextâ€],button{
width:100%;
appearance:none;
background:var(â€“bg);
color:var(â€“text);
border:1px solid var(â€“border);
border-radius:12px;
padding:12px 16px;
font-family: â€˜Interâ€™, sans-serif;
font-size: 0.95rem;
transition: all 0.3s ease;
}

select:focus,input:focus,button:focus{
outline:none;
border-color:var(â€“accent);
box-shadow: 0 0 0 3px var(â€“accent-glow);
background: var(â€“card);
}

select:hover,input:hover{
border-color:var(â€“accent);
}

select {
cursor: pointer;
background-image: url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ width=â€˜16â€™ height=â€˜16â€™ viewBox=â€˜0 0 24 24â€™ fill=â€˜noneâ€™ stroke=â€™%233b82f6â€™ stroke-width=â€˜2â€™ stroke-linecap=â€˜roundâ€™ stroke-linejoin=â€˜roundâ€™%3E%3Cpolyline points=â€˜6 9 12 15 18 9â€™%3E%3C/polyline%3E%3C/svg%3Eâ€);
background-repeat: no-repeat;
background-position: right 12px center;
padding-right: 40px;
}

.rowline{
display:flex;
gap:12px;
align-items:center;
flex-wrap:wrap;
}

.muted{
color:var(â€“muted);
}

.hint{
font-size:0.8rem;
color:var(â€“muted);
margin-top:6px;
font-weight: 500;
}

.warn{
color:var(â€“danger);
font-size:0.875rem;
margin-top:8px;
display:none;
font-weight:600;
padding: 8px 12px;
background: rgba(239, 68, 68, 0.1);
border-radius: 8px;
}

.searchWrap{
max-width:360px;
min-width:220px;
}

@media (max-width:900px){
.searchWrap{
max-width:100%;
}
}

.result{
display:flex;
align-items:baseline;
gap:16px;
margin-bottom:24px;
flex-wrap:wrap;
padding: 20px;
background: linear-gradient(135deg, var(â€“accent-glow), transparent);
border-radius: 12px;
border: 1px solid var(â€“border);
}

.result .big{
font-size:3rem;
font-weight:900;
letter-spacing:0.5px;
background: linear-gradient(135deg, var(â€“accent), var(â€“accent-hover));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
animation: fadeIn 0.5s ease;
}

.result .small{
font-size:1rem;
font-weight:500;
}

.tableWrap{
margin-top:20px;
overflow-x:auto;
-webkit-overflow-scrolling:touch;
border:1px solid var(â€“border);
border-radius:12px;
background: var(â€“bg);
}

table{
min-width:720px;
width:100%;
border-collapse:separate;
border-spacing:0;
}

th,td{
padding:14px 16px;
border-bottom:1px solid var(â€“border);
text-align:left;
white-space:nowrap;
transition: all 0.2s ease;
}

thead th{
font-size:0.8rem;
color:var(â€“muted);
font-weight:700;
position:sticky;
top:0;
background:var(â€“card);
backdrop-filter: blur(10px);
z-index:1;
text-transform: uppercase;
letter-spacing: 0.5px;
}

tbody tr{
transition: all 0.2s ease;
}

tbody tr:hover{
background: var(â€“card-hover);
}

tbody tr:last-child td{
border-bottom:0;
}

td.ok{
color:var(â€“success);
font-weight:700;
font-variant-numeric: tabular-nums;
}

td.err{
color:var(â€“danger);
opacity: 0.5;
}

td:first-child, th:first-child{
position:sticky;
left:0;
background:var(â€“card);
backdrop-filter: blur(10px);
z-index:2;
font-weight: 600;
}

/* Enhanced Summary */
.summary{
margin-top:24px;
padding:24px;
border:1px solid var(â€“border);
border-radius:var(â€“radius);
background: var(â€“card);
backdrop-filter: blur(20px);
animation: fadeIn 0.6s ease;
}

.summary strong {
font-size: 1.1rem;
font-weight: 700;
letter-spacing: 0.3px;
}

.sum-grid{
display:grid;
grid-template-columns:repeat(2,minmax(0,1fr));
gap:12px;
margin-top:16px;
}

@media (max-width:700px){
.sum-grid{
grid-template-columns:1fr;
}
}

.srow{
display:flex;
gap:12px;
align-items:center;
justify-content:space-between;
background:var(â€“badge);
border:1px solid var(â€“badge-border);
border-radius:12px;
padding:14px 16px;
transition: all 0.3s ease;
}

.srow:hover {
transform: translateX(4px);
border-color: var(â€“accent);
box-shadow: 0 4px 12px var(â€“accent-glow);
}

.slabel{
font-weight:600;
color: var(â€“muted);
font-size: 0.9rem;
}

.sval{
font-variant-numeric:tabular-nums;
font-weight: 700;
font-size: 1rem;
}

.badges{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-top:16px;
}

.badge{
background: linear-gradient(135deg, var(â€“badge), var(â€“badge-border));
border:1px solid var(â€“badge-border);
padding:8px 16px;
border-radius:999px;
font-size:0.85rem;
font-weight:600;
transition: all 0.3s ease;
animation: fadeIn 0.7s ease;
}

.badge:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px var(â€“accent-glow);
}

.copybtn{
margin-left:auto;
background: var(â€“accent);
color: #fff;
border-color: var(â€“accent);
padding: 10px 20px;
font-weight: 600;
cursor: pointer;
}

.copybtn:hover{
background: var(â€“accent-hover);
transform: translateY(-2px);
box-shadow: 0 4px 20px var(â€“accent-glow);
}

/* Checkbox styling */
input[type=â€œcheckboxâ€] {
width: 20px;
height: 20px;
cursor: pointer;
accent-color: var(â€“accent);
}

/* Footer */
.footer{
margin:32px 0 16px;
}

.foot-card{
background:var(â€“card);
backdrop-filter: blur(20px);
border:1px solid var(â€“border);
border-radius:var(â€“radius);
box-shadow:var(â€“shadow);
padding:20px 24px;
animation: fadeIn 0.8s ease;
}

.foot-title{
font-weight:800;
letter-spacing:0.3px;
margin-bottom:8px;
font-size: 1.1rem;
}

.foot-text{
color:var(â€“muted);
font-size:0.92rem;
line-height: 1.6;
}

/* Loading animation */
@keyframes shimmer {
0% { background-position: -1000px 0; }
100% { background-position: 1000px 0; }
}

.loading {
animation: shimmer 2s infinite;
background: linear-gradient(90deg, var(â€“card) 0%, var(â€“card-hover) 50%, var(â€“card) 100%);
background-size: 1000px 100%;
}

/* Smooth transitions for theme switching */

- {
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }

select, input, button, .card, .badge, .srow {
transition: all 0.3s ease;
}
</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="pill">âœ¨ Residual App â€” By Ricardo (11/25 Programs)</div>
        <button id="themeBtn" class="theme" type="button">ğŸŒ™ Dark Mode</button>
      </div>
    </div>
<div class="card controls">
  <div class="grid g3">
    <div>
      <label>ğŸš— Model Family</label>
      <select id="familySel"></select>
    </div>
    <div>
      <label>ğŸ“… Model Year</label>
      <select id="yearSel"></select>
    </div>
    <div>
      <label>ğŸ¯ Trim</label>
      <select id="trimSel"></select>
      <div class="hint" id="trimCount"></div>
      <div class="warn" id="trimWarn">âš ï¸ No trims found for this family/year. Check JSON spelling/case.</div>
    </div>
  </div>

  <div class="grid g3" style="margin-top:16px">
    <div class="searchWrap">
      <label>ğŸ” Search Trim</label>
      <input id="trimSearch" type="text" placeholder="Type to filter by name or codeâ€¦" />
    </div>
    <div>
      <label>â±ï¸ Term (months)</label>
      <select id="termSel"></select>
    </div>
    <div class="rowline" style="margin-top:28px">
      <label class="rowline" style="gap:8px;">
        <input id="pacpoToggle" type="checkbox" />
        <span>+2% PACPO</span>
      </label>
      <label class="rowline" style="gap:8px;">
        <input id="hideNA" type="checkbox" />
        <span>Hide N/A</span>
      </label>
      <div class="pill" id="codeBadge" style="font-size:0.85rem;padding:8px 14px;">MY Code: â€”</div>
    </div>
  </div>

  <div class="grid g2" style="margin-top:16px">
    <div>
      <label>ğŸ›£ï¸ Miles at Inception</label>
      <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
      <div class="hint">Summary shows this adjustment even when it's +0%.</div>
    </div>
    <div>
      <label>ğŸ“Š Miles per Year</label>
      <select id="annualMilesSel"></select>
    </div>
  </div>
</div>

<div class="card" style="margin-top:20px">
  <div class="result">
    <div class="big" id="finalOut">â€”</div>
    <div class="small muted" id="detailOut"></div>
  </div>

  <div class="tableWrap">
    <table id="residualTable">
      <thead><tr id="theadRow"></tr></thead>
      <tbody><tr id="tvalRow"></tr></tbody>
    </table>
  </div>

  <div class="summary" id="summaryBox">

  </div>

<script>
(async function(){
  // ========= THEME =========
  const themeBtn = document.getElementById('themeBtn');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  themeBtn.innerHTML = prefersDark ? 'â˜€ï¸ Light Mode' : 'ğŸŒ™ Dark Mode';
  themeBtn.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    themeBtn.innerHTML = next === 'light' ? 'ğŸŒ™ Dark Mode' : 'â˜€ï¸ Light Mode';
  });

  // ========= DOM HANDLES =========
  const familySel = document.getElementById('familySel');
  const yearSel = document.getElementById('yearSel');
  const trimSel = document.getElementById('trimSel');
  const trimSearch = document.getElementById('trimSearch');
  const trimCount = document.getElementById('trimCount');
  const trimWarn = document.getElementById('trimWarn');
  const termSel = document.getElementById('termSel');
  const pacpoToggle = document.getElementById('pacpoToggle');
  const hideNA = document.getElementById('hideNA');
  const codeBadge = document.getElementById('codeBadge');
  const finalOut = document.getElementById('finalOut');
  const detailOut = document.getElementById('detailOut');
  const theadRow = document.getElementById('theadRow');
  const tvalRow  = document.getElementById('tvalRow');
  const annualMilesSel = document.getElementById('annualMilesSel');
  const odoInput = document.getElementById('odoInput');

  // Summary fields
  const sumYear = document.getElementById('sumYear');
  const sumFamily = document.getElementById('sumFamily');
  const sumTrim = document.getElementById('sumTrim');
  const sumTerm = document.getElementById('sumTerm');
  const sumMilesYear = document.getElementById('sumMilesYear');
  const sumOdo = document.getElementById('sumOdo');
  const sumFinal = document.getElementById('sumFinal');
  const badgeRow = document.getElementById('badgeRow');
  const copyBtn = document.getElementById('copyBtn');

  // ========= FETCH JSON =========
  const params = new URLSearchParams(location.search);
  const jsonFile = params.get('data') || 'porsche_residuals_all.json';
  const cacheBuster = `v=${Date.now()}`;
  let data;

  try {
    const res = await fetch(`${jsonFile}?${cacheBuster}`, {cache: 'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status} loading ${jsonFile}`);
    data = await res.json();
  } catch (err) {
    alert(`Failed to load JSON: ${err.message}.
- Ensure ${jsonFile} exists in the same folder as this HTML
- If using file://, the browser may block fetch; use GitHub Pages or a local server`);
    throw err;
  }
  window.__data = data;

  const MONTHS = data.months || ["12","18","24","27","30","36","39","42","48","51","60"];
  const PACPO = data.pacpo_bonus_percent ?? 2;

  // ========= HELPERS =========
  function normalizeYearKey(k){
    const s = String(k).trim();
    const mPlain = s.match(/^(20\d{2})$/);
    if (mPlain) return { display: `MY${mPlain[1].slice(-2)}`, key: k };
    const mMY = s.toUpperCase().replace(/\s+/g,'').match(/^MY(\d{2})$/);
    if (mMY) return { display: `MY${mMY[1]}`, key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj!=="object") return undefined;
    const target = String(name).replace(/\s+/g,'').toLowerCase();
    for(const k of Object.keys(obj)){
      const norm = k.replace(/\s+/g,'').toLowerCase();
      if(norm === target) return obj[k];
    }
    return undefined;
  }

  // Families with flat 718 (accept nested or top-level)
  function getVirtualFamilies(){
    const out = new Set();
    const models = data.models || {};
    Object.keys(models).forEach(f=>{
      if(f === '718'){
        const cay = getCaseInsensitive(models['718'],'Cayman');
        const box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman');
        if (box) out.add('718 Boxster');
      } else {
        out.add(f);
      }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    const order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort((a,b)=> order.indexOf(a) - order.indexOf(b));
  }
  function branchForFamily(famDisp){
    const models = data.models || {};
    if (famDisp === '718 Cayman'){
      return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    }
    if (famDisp === '718 Boxster'){
      return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    }
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    const out = new Set();
    const branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(y => out.add(normalizeYearKey(y).display));
    return Array.from(out).sort((a,b)=>{
      const ay = parseInt(a.replace(/\D/g,''),10);
      const by = parseInt(b.replace(/\D/g,''),10);
      if (Number.isNaN(ay) || Number.isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }

  // ========= UI POPULATION =========
  function populateFamilies(){
    familySel.innerHTML = '';
    getVirtualFamilies().forEach(f=>{
      const opt = document.createElement('option'); opt.value=f; opt.textContent=f; familySel.appendChild(opt);
    });
  }
  function populateYears(){
    yearSel.innerHTML = '';
    yearsForFamily(familySel.value).forEach(d=>{
      const opt = document.createElement('option'); opt.value=d; opt.textContent=d; yearSel.appendChild(opt);
    });
  }

  let fullTrimList = [];
  function collectTrimsForYear(){
    fullTrimList = [];
    const branch = branchForFamily(familySel.value);
    const dispYear = yearSel.value;
    const yearKeys = Object.keys(branch).filter(k => normalizeYearKey(k).display === dispYear);
    const yearKey = yearKeys[0];
    const rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(([code,row])=>{
      fullTrimList.push({code, model: row.model || code});
    });
  }
  function populateTrims(filterTerm=""){
    trimSel.innerHTML = '';
    const term = filterTerm.trim().toLowerCase();
    const filtered = fullTrimList.filter(x=>{
      const hay = (x.model + " " + x.code).toLowerCase();
      return hay.includes(term);
    });
    filtered.forEach(({code,model})=>{
      const opt = document.createElement('option');
      opt.value = code; opt.textContent = model; opt.dataset.code = code;
      trimSel.appendChild(opt);
    });
    trimCount.textContent = filtered.length ? `${filtered.length} trim(s) available` : 'No trims match filter';
    trimWarn.style.display = filtered.length ? 'none' : 'block';
  }
  function populateTerms(){
    termSel.innerHTML = '';
    (data.months || ["12","18","24","27","30","36","39","42","48","51","60"]).forEach(m=>{
      const opt = document.createElement('option'); opt.value=m; opt.textContent=`${m} months`; termSel.appendChild(opt);
    });
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML = '';
    const milesMap = data?.annual_mileage_adjustments_percent?.miles_per_year || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(k=>parseInt(k,10)).sort((a,b)=>a-b).forEach(k=>{
      const opt=document.createElement('option'); opt.value=String(k); opt.textContent=`${k.toLocaleString()} mi/yr`;
      annualMilesSel.appendChild(opt);
    });
    annualMilesSel.value = "15000";
  }

  // ========= CALC HELPERS =========
  function parseRange(str){
    if(!str) return null;
    const s = str.replace(/,/g,'').replace(/\s/g,'');
    const parts = s.split(/â€“|-/);
    if(parts.length !== 2) return null;
    const a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(Number.isNaN(a)||Number.isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(myKey, odo){
    const bands = data?.mileage_at_inception_adjustments_percent?.[myKey];
    if(!bands || odo==null) return 0;
    for(const band of bands){
      const rng = parseRange(band.miles_range);
      if(!rng) continue;
      const [lo,hi] = rng;
      if(odo >= lo && odo <= hi) return band.adj || 0;
    }
    return 0;
  }
  function buildHeader(visibleMonths){
    theadRow.innerHTML = '';
    const th1 = document.createElement('th'); th1.textContent = 'Trim / Term';
    theadRow.appendChild(th1);
    visibleMonths.forEach(m=>{ const th=document.createElement('th'); th.textContent=`${m} mo`; theadRow.appendChild(th); });
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    return MONTHS.filter(m => entry?.residuals?.[m] != null);
  }

  // ========= COMPUTE =========
  function compute(){
    const fam = familySel.value;
    const branch = branchForFamily(fam);
    const dispYear = yearSel.value;

    const yearKeys = Object.keys(branch).filter(k => normalizeYearKey(k).display === dispYear);
    const yrKey = yearKeys[0];
    const code = trimSel.value;
    const term = termSel.value;
    const milesPerYear = parseInt(annualMilesSel.value,10);
    const odo = odoInput.value ? parseInt(odoInput.value.replace(/,/g,''),10) : null;

    if(!yrKey || !code){ return; }
    const entry = branch[yrKey][code];
    const base = term ? (entry?.residuals?.[term] ?? null) : null;

    const pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent ?? 2) : 0;
    const milesMap = data?.annual_mileage_adjustments_percent?.miles_per_year || {};
    let annualAdj = 0;
    if(base !== null && parseInt(term||"0",10) >= 24){
      annualAdj = milesMap[String(milesPerYear)] ?? 0;
    }

    const inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\s+/g,'')];
    let inceptionAdj = 0;
    for (const cand of inceptionKeyCandidates) {
      const bands = data?.mileage_at_inception_adjustments_percent?.[cand];
      if (bands) { inceptionAdj = findInceptionAdj(cand, odo); break; }
    }

    const monthsShown = visibleMonthsFor(entry);
    buildHeader(monthsShown);

    const final = (base === null || term==null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final === null ? 'â€”' : `${final}%`;
    detailOut.textContent = final===null ? `Select a term to calculate` : `Final residual with all adjustments applied`;
    codeBadge.textContent = `MY Code: ${code || 'â€”'}`;

    // Table
    tvalRow.innerHTML = '';
    const lead = document.createElement('td'); lead.textContent = entry?.model || 'â€”';
    tvalRow.appendChild(lead);
    monthsShown.forEach(m=>{
      const td = document.createElement('td');
      const v = entry?.residuals?.[m];
      let shown = 'â€”';
      if(v!==null && v!==undefined){
        const mN = parseInt(m,10);
        const aAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] ?? 0) : 0;
        const total = v + pacpoAdj + aAdj + inceptionAdj;
        shown = `${total}%`; td.classList.add('ok');
      } else { td.classList.add('err'); }
      td.textContent = shown; tvalRow.appendChild(td);
    });

    // Summary
    sumYear.textContent = dispYear || 'â€”';
    sumFamily.textContent = fam || 'â€”';
    sumTrim.textContent = entry?.model ?? 'â€”';
    sumTerm.textContent = term ? `${term} mo` : 'â€”';
    sumMilesYear.textContent = isFinite(milesPerYear) ? `${milesPerYear.toLocaleString()} mi/yr` : 'â€”';
    sumOdo.textContent = (odo!=null && !Number.isNaN(odo)) ? `${odo.toLocaleString()} mi` : 'â€”';

    // Badges
    badgeRow.innerHTML = '';
    if (base !== null && term) {
      const b = document.createElement('div'); b.className='badge'; b.textContent = `Base ${base}%`; badgeRow.appendChild(b);
    }
    if (pacpoToggle.checked){
      const b = document.createElement('div'); b.className='badge'; b.textContent = `+${PACPO}% PACPO`; badgeRow.appendChild(b);
    }
    if (term && parseInt(term,10) >= 24){
      const a = document.createElement('div'); a.className='badge';
      const adj = annualAdj>=0?`+${annualAdj}%`:`${annualAdj}%`;
      a.textContent = `${adj} Annual Miles`; badgeRow.appendChild(a);
    }
    if (odo != null && !Number.isNaN(odo)){
      const i = document.createElement('div'); i.className='badge';
      const adj = inceptionAdj>=0?`+${inceptionAdj}%`:`${inceptionAdj}%`;
      i.textContent = `${adj} Inception`; badgeRow.appendChild(i);
    }

    sumFinal.textContent = final===null ? 'â€”' : `${final}%`;
  }

  // ========= COPY =========
  copyBtn.addEventListener('click', ()=>{
    const text = [
      `Year: ${sumYear.textContent}`,
      `Family: ${sumFamily.textContent}`,
      `Trim: ${sumTrim.textContent}`,
      `Term: ${sumTerm.textContent}`,
      `Miles/Year: ${sumMilesYear.textContent}`,
      `Odometer: ${sumOdo.textContent}`,
      `Final Residual: ${sumFinal.textContent}`
    ].join(' | ');
    navigator.clipboard.writeText(text).then(()=>{
      const old = copyBtn.innerHTML;
      copyBtn.innerHTML = 'âœ… Copied!';
      setTimeout(()=>copyBtn.innerHTML = old, 1200);
    });
  });

  // ========= INIT / EVENTS =========
  function init(){
    populateFamilies();
    populateYears();
    populateTerms();
    populateAnnualMiles();
    collectTrimsForYear(); populateTrims();
    compute();
  }

  familySel.addEventListener('change', ()=>{ populateYears(); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', ()=>{ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', ()=>{ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', compute);
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);

  init();
})();
</script>

</body>
</html>
